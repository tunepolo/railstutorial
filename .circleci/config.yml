version: 2

defaults: &defaults
  working_directory: ~/workspace
  docker:
    - image: circleci/ruby:2.6.1-node-browsers
      environment:
        RAILS_ENV: test
        REVIEWDOG_VERSION: 0.9.11

jobs:
  bundle_dependencies:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/workspace
      - restore_cache:
          keys:
          - gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          - gem-cache-{{ arch }}-{{ .Branch }}
          - gem-cache
      - run:
          name: Bundle Install
          command: bundle install --jobs=4 --retry=3 --path vendor/bundle
      # bundle installのデータをキャッシュ
      - save_cache:
          key: gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - ~workspace/vendor/bundle
      - persist_to_workspace:
          root: .
          paths: vendor/bundle

  rake_test:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/workspace
      - run: bundle --path vendor/bundle

      # 初期設定
      - run:
          name: Database setup
          command: |
            rails db:create
            rails db:migrate

      - run:
          name: Rails Test
          command: rails test

      # Reviewdogのインストール
      - run:
          name: Install Reviewdog
          command: |
            curl -fSL https://github.com/haya14busa/reviewdog/releases/download/$REVIEWDOG_VERSION/reviewdog_linux_amd64 -o reviewdog && chmod +x ./reviewdog

      # Rubocop & Reviewdogの実行
      - run:
          name: Rubocop & Reviewdog
          command: bundle exec rubocop | ./reviewdog -f=rubocop -reporter=github-pr-review

workflows:
  version: 2
  build_and_test:
    jobs:
      - bundle_dependencies
      - rake_test:
          requires:
            - bundle_dependencies
